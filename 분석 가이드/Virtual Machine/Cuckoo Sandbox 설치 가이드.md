## VM 환경

| VM    | OS           | CPU | RAM | Disk |
| ----- | ------------ | --- | --- | ---- |
| Host  | ubuntu 16.04 | 4   | 8   | 60   |
| Guest | Win7-86      | 2   | 2   |      |
(enable amd-v on ubuntu vm)

## host vm setting

Cuckoo 공식 문서에서는 ubuntu 16.04를 추천함.

### 자동 업데이트 끄기

System Settings > Software & Updates

Automatically check for updates => Never

![](images/Cuckoo%20Sandbox%20설치%20가이드/IMG-Cuckoo%20Sandbox%20설치%20가이드-20240913113432346.png)

아래 명령어를 사용하여 파일 수정

```bash
sudo nano /etc/apt/apt.conf.d/10periodic
```

![](images/Cuckoo%20Sandbox%20설치%20가이드/IMG-Cuckoo%20Sandbox%20설치%20가이드-20240913113440581.png)

### 화면 보호기 끄기

System Settings > Brightness & Lock

Turn screen off when inactive for => Never

![](images/Cuckoo%20Sandbox%20설치%20가이드/IMG-Cuckoo%20Sandbox%20설치%20가이드-20240913113448216.png)

### build-essential, git, open-vm-tools-desktop 설치

```bash
sudo apt update
sudo apt upgrade
sudo apt-get install build-essential git -y
sudo apt-get autoremove open-vm-tools
sudo apt-get install open-vm-tools-desktop
reboot
```

## Cuckoo 설치

필요한 python 관련 패키지 다운

```bash
sudo apt-get install python python-pip python-dev libffi-dev libssl-dev -y
sudo apt-get install python-virtualenv python-setuptools -y
sudo apt-get install libjpeg-dev zlib1g-dev -y
```

virtualenv를 사용하여 python 가상 환경 사용

```bash
############################################################
############################################################
# 16.04 버전
virtualenv cuckoo
. cuckoo/bin/activate
############################################################
# 18.04 버전
sudo nano cuckoo-setup-virtualenv.sh
-----------------------------------------
#!/usr/bin/env bash

# NOTES: Run this script as: sudo -u <USERNAME> cuckoo-setup-virtualenv.sh

# install virtualenv
sudo apt-get update && sudo apt-get -y install virtualenv

# install virtualenvwrapper
sudo apt-get -y install virtualenvwrapper

echo "source /usr/share/virtualenvwrapper/virtualenvwrapper.sh" >> ~/.bashrc

# install pip for python3
sudo apt-get -y install python3-pip

# turn on bash auto-complete for pip
pip3 completion --bash >> ~/.bashrc

# avoid installing with root
pip3 install --user virtualenvwrapper

echo "export VIRTUALENVWRAPPER_PYTHON=/usr/bin/python3" >> ~/.bashrc

echo "source ~/.local/bin/virtualenvwrapper.sh" >> ~/.bashrc

export WORKON_HOME=~/.virtualenvs

echo "export WORKON_HOME=~/.virtualenvs" >> ~/.bashrc

echo "export PIP_VIRTUALENV_BASE=~/.virtualenvs" >> ~/.bashrc 
---------------------------------
sudo chmod +x cuckoo-setup-virtualenv.sh
sudo -u *current user* cuckoo-setup-virtualenv.sh
source ~/.bashrc
mkvirtualenv -p python2.7 cuckoo
############################################################
############################################################
```

가상 환경이 적용된 모습

![](images/Cuckoo%20Sandbox%20설치%20가이드/IMG-Cuckoo%20Sandbox%20설치%20가이드-20240913140225298.png)

mongdb 설치 및 서비스 등록

```bash
sudo apt-get install mongodb -y
sudo systemctl enable mongodb
```

volatility 설치

```bash
pip install openpyxl
pip install ujson
pip install pycrypto
pip install distorm3
pip install pytz

git clone https://github.com/volatilityfoundation/volatility.git
cd volatility
python setup.py build
python setup.py install
cd ../
```

m2crypto 설치

```bash
sudo apt-get install swig -y
pip install m2crypto==0.24.0
```

tcpdump 설치 및 설정

```bash
sudo apt-get install tcpdump apparmor-utils -y

sudo groupadd pcap
sudo usermod -a -G pcap "your_name"
sudo chgrp pcap /usr/sbin/tcpdump
sudo setcap cap_net_raw,cap_net_admin=eip /usr/sbin/tcpdump
getcap /usr/sbin/tcpdump
sudo aa-disable /usr/sbin/tcpdump
```

virtualbox 설치

```bash
echo deb http://download.virtualbox.org/virtualbox/debian xenial contrib | sudo tee -a /etc/apt/sources.list.d/virtualbox.list
wget -q https://www.virtualbox.org/download/oracle_vbox_2016.asc -O- | sudo apt-key add -
sudo apt-get update
sudo apt-get install virtualbox-5.2 -y
```

유저 등록 및 cuckoo 설치

```bash
sudo usermod -a -G vboxusers "your_name"

pip install -U cuckoo
```


## vmcloak을 이용한 게스트 vm 생성 및 설정

vmcloak을 사용하여 vm 생성.
iso 파일을 home/"your name" 디렉토리에 복사.

```bash
pip install -U vmcloak

# Get Windows7 Iso File Somewhere
sudo mkdir /mnt/win7x86
sudo chown user:user /mnt/win7x86
sudo mount -o ro,loop Win7_Pro_SP1_English_x32.iso /mnt/win7x86
vmcloak-vboxnet0
vmcloak init --win7x86 --hddsize 32 --cpus 2 --ramsize 2048 win7x86base
# vm name이 win7x86_192.168.56.101, win7x86_192.168.56.102 이런 식으로 생성됨.
# ip 주소는 192.168.56.101, 192.168.56.102 이런 식으로 할당됨.
vmcloak snapshot --count 1 win7x86base win7x86_192.168.56.10
vmcloak list vms
```


## 네트워크 설정

### cuckoo 설정

```bash
cuckoo init
cuckoo community
cd /home/user/.cuckoo/conf

# disable version check
nano cuckoo.conf
```

![](images/Cuckoo%20Sandbox%20설치%20가이드/IMG-Cuckoo%20Sandbox%20설치%20가이드-20240914003218165.png)

```
# while read -r vm ip; do cuckoo machine --add $vm $ip; done < <(vmcloak list vms) ;vmcloack 사용시
cuckoo machine --add "vm name" "vm ip"

# remove cuckoo from machine
nano virtualbox.conf

```

![](images/Cuckoo%20Sandbox%20설치%20가이드/IMG-Cuckoo%20Sandbox%20설치%20가이드-20240913204547297.png)

```bash
# add internet routing your interface name
nano routing.conf
```

![](images/Cuckoo%20Sandbox%20설치%20가이드/IMG-Cuckoo%20Sandbox%20설치%20가이드-20240913182817809.png)

```bash
# enable mongodb
nano reporting.conf
```

![](images/Cuckoo%20Sandbox%20설치%20가이드/IMG-Cuckoo%20Sandbox%20설치%20가이드-20240913183135145.png)


### 호스트 포워딩 설정

```bash
sudo sysctl -w net.ipv4.conf.vboxnet0.forwarding=1
sudo sysctl -w net.ipv4.conf.*your interface name*.forwarding=1

sudo nano /etc/sysctl.conf
```

아래 두줄을 추가

```
net.ipv4.conf.vboxnet0.forwarding=1
net.ipv4.conf.*your interface name*.forwarding=1
```

![](images/Cuckoo%20Sandbox%20설치%20가이드/IMG-Cuckoo%20Sandbox%20설치%20가이드-20240913172557476.png)

```
sudo iptables -t nat -A POSTROUTING -o "your interface name" -s 192.168.56.0/24 -j MASQUERADE
sudo iptables -P FORWARD DROP
sudo iptables -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT
sudo iptables -A FORWARD -s 192.168.56.0/24 -j ACCEPT
```



## cuckoo 실행

```bash
# 가상 환경 활성화
. cuckoo/bin/activate
# rooting 실행
cuckoo rooter --sudo --group "your name"
# cuckoo 실행
cuckoo
# web 서버 생성
cuckoo web --host 192.168.10.133 --port 8080
```

![](images/Cuckoo%20Sandbox%20설치%20가이드/IMG-Cuckoo%20Sandbox%20설치%20가이드-20240913183712014.png)