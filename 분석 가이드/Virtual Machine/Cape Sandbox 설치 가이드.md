## VM 환경

| VM    | OS           | CPU | RAM | Disk |
| ----- | ------------ | --- | --- | ---- |
| Host  | ubuntu 22.04 | 4   | 8   | 60   |
| Guest | Win10x64     | 2   | 4   | 40   |
(enable amd-v on host vm)

## host vm setting

Cape 공식 문서에서는 ubuntu 22.04를 추천함.

### 자동 업데이트 끄기

Software & Updates

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240916140631896.png)

아래 명령어를 사용하여 파일 수정

```bash
sudo nano /etc/apt/apt.conf.d/10periodic
```

```bash
APT::Periodic::Update-Package-Lists "0";
APT::Periodic::Download-Upgradeable-Packages "0";
APT::Periodic::AutocleanInterval "0";
APT::Periodic::Unattended-Upgrade "0";
```

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240916140829343.png)

### 화면 보호기 끄기

Settings > Screen

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240916140926194.png)

### kvm, virt-manager 설치

```bash
sudo apt update && sudo apt upgrade -y && sudo reboot
sudo apt-get install -y git build-essential cmake ninja-build python3-dev cython3 pybind11-dev python3-pip libre2-dev acpica-tools net-tools gperf dbus-x11 graphviz graphviz-dev

wget https://raw.githubusercontent.com/doomedraven/Tools/master/Virtualization/kvm-qemu.sh

# acpi 설정
mkdir temp && cd temp
sudo acpidump > acpidump.out
sudo acpixtract -a acpidump.out
sudo iasl -d dsdt.dat
cd ..
sed -i 's/<WOOT>/*아래 스샷에서 박스가 가리키는 문자열*/g' kvm-qemu.sh
```

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240916141214185.png)

```bash
sudo chmod +x kvm-qemu.sh
sudo ./kvm-qemu.sh all cape | tee kvm-qemu.log
sudo reboot
sudo ./kvm-qemu.sh virtmanager cape | tee kvm-qemu-virtmanager.log
sudo reboot
```

### cape 설치

```bash
git clone https://github.com/kevoreilly/CAPEv2.git
cd CAPEv2/installer

# NETWORK_IFACE, PASSWD 변경
sudo nano cape2.sh
```

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240916141924081.png)

![](../../../../Pasted%20image%2020240916142341.png)
```bash
sudo chmod +x cape2.sh
sudo ./cape2.sh base | tee cape.log
sudo reboot

# psql 설정
sudo -u postgres psql
ALTER DATABASE cape OWNER TO cape;
\q

# poetry 필요 패키지 설치
cd /opt/CAPEv2
sudo poetry install
sudo -u cape poetry run pip install -r extra/optional_dependencies.txt
```

### conf 수정

```bash
# cuckoo.conf 수정
nano conf/cuckoo.conf
```

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240918101555659.png)

free space가 부족하다는 오류가 뜰 때가 있는데, 아래 설정을 변경해주면 됨.

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240918101719249.png)

```bash
# kvm.config 수정  
nano conf/kvm.conf
```

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240916212948872.png)

```bash
# routing.conf
nano conf/routing.conf
```

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240918102021017.png)

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240918101915448.png)

## guest vm setting

### vm 생성성

ubuntu에서 게스트 win10에 설치할 아래 파일들을 다운로드 해놓음. cape에서는 파이썬 3.10.6 32bit 버전을 설치를 권장함.

```bash
# 디펜더 리무버
https://github.com/ionuttbara/windows-defender-remover/releases/download/release_def_12_8/DefenderRemover.exe

# 윈도우 커스텀 ps
https://github.com/W4RH4WK/Debloat-Windows-10

# python 3.10.6 32
https://www.python.org/ftp/python/3.10.6/python-3.10.6.exe
```

virt-manger로 vm 생성. cape에서는 Win10x64_21H2를 권장.

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240916192831244.png)

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240916193105213.png)

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240916193208593.png)

vm 명은 kvm.conf에서 설정한 이름과 같게 해야하고 인터넷이 연결되어 있으면 오류가 뜰 때가 있기 때문에 ubuntu의 web-connection을 off 해야함.

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240916192709897.png)

### 윈도우 설정정

win10 설치가 완료되면 윈도우 보안에 가서 virus & threat protection setting에 존재하는 모든 기능을 off함.

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240916200607379.png)
Windows Defender FireWall With Advanced Security에서 Domain, Private, Public 방화벽을 Off.

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240916202800348.png)

ubuntu에서 간단히 웹서버 생성

```
python3 -m http.server 8080
```

윈도우에서 virbr0 ip를 사용해 접속하면 아래와 같음.

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240916200215952.png)

준비한 파일들을 다운로드. CAPEv2/agent/agent.py도 내용을 복사해서 파일을 생성함. 이때 agent.py라는 이름을 그대로 사용하지 않는데 이는 멀웨어의 샌드박스 탐지를 회피하기 위함임. 다운로드가 완료되면 웹서버는 ctrl+c로 종료하면 됨.

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240916200726217.png)

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240916212237079.png)

DefendRemover.exe를 관리자 권한으로 실행 후 Y 입력. 실행이 완료되면 자동으로 재시작됨.

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240916201622038.png)

재시작 후에는 Services에 들어가서 Windows Update 서비스를 Stop하고 Disabled 함.

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240916201523445.png)

python을 설치. 이 때 아래 체크박스를 체크 해야함.

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240916202201501.png)

설치가 완료되면 인터넷을 다시 연결하고 아래 패키지를 다운

```
python -m pip install --upgrade pip
python -m pip install --upgrade pillow
```

파워셀을 관리자 권한으로 실행 후 아래 코드 입력

```powershell
Set-ExecutionPolicy Unrestricted # A 입력
netsh interface teredo set state disabled
```

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240918103040099.png)

gpedit을 설치

```cmd
FOR %F IN ("%SystemRoot%\servicing\Packages\Microsoft-Windows-GroupPolicy-ClientTools-Package~*.mum") DO (DISM /Online /NoRestart /Add-Package:"%F")
FOR %F IN ("%SystemRoot%\servicing\Packages\Microsoft-Windows-GroupPolicy-ClientExtensions-Package~*.mum") DO (DISM /Online /NoRestart /Add-Package:"%F")
```

Computer Configuration > Administrative Templates > Network > DNS Client > Turn off Multicast Name Resolution => Eanbled

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240918104558473.png)

Computer Configuration > Administrative Templates > System > Internet Communication Management > Restrict Internet Communication => Eanbled

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240918104347560.png)
### Debloat Scripts 실행

```powershell
cd C:\User\user\Download\Debloat-Windows-10-master\scripts\
ls -Recurse *.ps*1 | Unblock-File
```

`disable-services.ps1`, `block-telemetry.ps1`, `remove-default-apps.ps1`, `remove-onedrive.ps1` 스크립트를 실행 후, utils 폴더로 이동해 `disable-scheduled-tasks.ps1`를 실행.

### 가상 네트워크 구성

virt-manager에서 default network를 삭제하고 hostonly 가상 네트워크를 생성.

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240916203729778.png)

win10x64 머신의 nic를 hostonly로 변경

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240916203825825.png)

Network and Sharing Center에서 아래와 같이 ip 설정을 변경. kvm.conf에서 설정한 것과 같은 ip를 사용해야 함.

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240916204056909.png)

### agent.py 설정

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240916212344322.png)

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240916212354619.png)

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240916212414004.png)

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240916212429213.png)

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240917150621697.png)

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240916212742640.png)

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240916212652828.png)

스냅샷 생성

## cape 재실행 및 rooter 실행

cape의 설정을 바꿨을 경우, 아래 코드를 실행해줘야 함.

```bash
cd /opt/CAPEv2
sudo systemctl restart cape*
sudo poetry run python3 utils/rooter.py -v -g cape
```

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240918111744004.png)

아래 주소로 접근하면 cape web 인터페이스에 접근 가능

```
http://192.168.10.136:8000/
```

![](images/Cape%20Sandbox%20설치%20가이드/IMG-Cape%20Sandbox%20설치%20가이드-20240918111641285.png)