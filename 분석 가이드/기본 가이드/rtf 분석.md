## rtf, Rich Text Format

마이크로소프트사가 개발한 규격. 문서 파일 형식으로 크로스 플랫폼 문서 교환을 위하여 만들어짐.
버전에 따라 다르긴 하지만 대부분의 문서 처리 프로그램은 rtf 파일을 읽고 쓸 수 있음.

- 파일 시그니처 = `{\rt`, `7B 5C 72 74`

![](images/rtf%20분석/IMG-rtf%20분석-20240920150101776.png)

## Analysis

rtf 파일의 경우 내부에 ole 파일을 포함할 수 있는데, 이로 인해 발생하는 취약점을 횔용한 멀웨어가 대부분

### 1. rtf 파일 내부 확인

rtf 파일은 난독화가 가능하기 때문에 rtfdump와 rtfobj의 기본 기능만으로는 ole 파일을 찾지 못할 수도 있음. rtfdump의 -F 옵션을 사용하면 OLE 임베디드 데이터를 찾아줌.

![](images/rtf%20분석/IMG-rtf%20분석-20240920152010595.png)

![](images/rtf%20분석/IMG-rtf%20분석-20240920152024251.png)

### 2. 임베디드 ole 파일 데이터 확인

equAtIon 문자열을 확인할 수 있는데, 이는 수식 취약점을 이용 했을 확률이 높음.

![](images/rtf%20분석/IMG-rtf%20분석-20240920152235575.png)

![](images/rtf%20분석/IMG-rtf%20분석-20240920152255262.png)

ole 파일을 덤프.

![](images/rtf%20분석/IMG-rtf%20분석-20240920152907732.png)

### 3. ole 파일 내부 확인

oledir를 사용하면 내부를 확인할 수 있음. rtf 파일에 임베디드된 ole 파일은 루트 항목에 clsid가 내장되어 있음.

![](images/rtf%20분석/IMG-rtf%20분석-20240920175959187.png)

![](images/rtf%20분석/IMG-rtf%20분석-20240920153032153.png)

oledump를 사용해서도 확인이 가능함. `--storage` 옵션을 사용하면 Root가 확인됨.

![](images/rtf%20분석/IMG-rtf%20분석-20240920165035358.png)

`-E "%CLSID% %CLSIDDESC%"` 옵션을 사용하면 clsid와 cve를 확인 가능. 

```
oledump.py --storage -E "%CLSID% %CLSIDDESC%" [file_path]
```

![](images/rtf%20분석/IMG-rtf%20분석-20240920154310923.png)

확인한 clsid는 `0002CE02-0000-0000-C000-000000000046`로 `Microsoft Equation 3.0`를 나타냄. regedit을 통해 EQNEDT32.exe를 사용함을 알 수 있음.

![](images/rtf%20분석/IMG-rtf%20분석-20240920175930978.png)

![](images/rtf%20분석/IMG-rtf%20분석-20240924113018663.png)

oledump를 사용해서 equation NaTIVe 객체 스트림을 덤프.

![](images/rtf%20분석/IMG-rtf%20분석-20240920214536634.png)

### 4. ole 객체 스트림 분석

rtf 악성 코드는 일반적으로 Font Record 0x8 값 이후에 나오는 Font Name 데이터에 40 byte 이상의 값을 넣어 EIP 제어하는 방식으로 동작함. 하지만 EQNEDT32.exe 내부에서 ole 객체에 존재하는  MTEF 바이트 스트림을 어떻게 파싱 하냐에 따라서 shellcode의 위치가 달라짐. 또한 어떤 취약점을 사용하냐에 따라서 overwrite되는 메모리 크기도 달라짐.

 🔗 [MTEF Header Info](https://rtf2latex2e.sourceforge.net/MTEF3.html#header_v2+)

때문에 특정 방법을 사용하기 보다는 EQNEDT32.exe에 디버거를 붙여서 분석해야 함. gflags를 이용하면 특정 프로그램 실행 시, 디버거를 붙일 수 있음.

![](images/rtf%20분석/IMG-rtf%20분석-20240921015628164.png)

gflags를 설정한 후, 파일을 열면 x32dbg가 실행됨. EQNEDT32.exe 내부를 확인 가능.

![](images/rtf%20분석/IMG-rtf%20분석-20240921015750075.png)