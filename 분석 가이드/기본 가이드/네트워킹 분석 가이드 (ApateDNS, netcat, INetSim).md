## 1. ApateDNS

### ApateDNS의 사용

- 악성 코드가 특정 URL의 IP 주소를 알아내기 위해 DNS request를 생성했는지 검사
- DNS request를 생성했다면, ApateDNS는 설정된 IP 주소(ex. 로컬 호스트)로 DNS reply를 생성
- 악성 코드는 특정 URL의 IP 주소를 분석가가 설정한 IP 주소(ex. 로컬 호스트)라고 착각하고 분석가가 설정한 IP 주소(ex. 로컬 호스트)로 통신을 시도하게 됨
- 분석가는 악성 코드가 생성한 패킷을 netcat, INetSim 등을 사용해 확인 가능
### ApateDNS 동작 원리

1. ApateDNS는 로컬 장비의 UDP 포트 53번을 리스닝 시작
	- 일반적으로 DNS request는 UDP 포트 53번를 사용
2. 악성 코드가 특정 URL의 IP 주소를 알아내기 위해 웹 서버로 DNS request를 보냄
3. Apdate는 해당 DNS request를 가로채 패킷 정보를 읽고, 지정된 IP 주소로 가짜 DNS reply를 생성
4. 앞서 수신하는 DNS request 패킷의 정보와 16진수/ASCII 결과를 출력

### ApateDNS 기능 및 설정

![IMG-네트워킹 분석 가이드 (ApateDNS, netcat, INetSim)-20240818160206326.png](images/네트워킹%20분석%20가이드%20(ApateDNS,%20netcat,%20INetSim)/IMG-네트워킹%20분석%20가이드%20(ApateDNS,%20netcat,%20INetSim)-20240818160206326.png)

- **Capture Window** = 캡처한 DNS request 정보를 표시
- **DNS Hex View** = 캡처한 DNS request 패킷 중 선택된 패킷을 Hex 값으로 표기
- **DNS Reply IP** = 악성 코드가 request한 특정 URL의 IP 주소를 어떤 IP 주소로 할지 설정
	- 127.0.01으로 설정 시, localhost로 reply
- **# of NXDOMAIN’s** = NXDOMAIN 오류를 n번 발생시킴
	- 악성 코드가 또 다른 URL로 DNS request를 생성하는지 확인할 때 사용
- **Selected Interface** = 어떤 인터페이스로 가짜 DNS reply를 내보낼지 설정

## 2. netcat

### netcat의 역할

- 악성 코드는 ApateDNS에 의해 분석가가 설정한 주소(ex. 로컬 호스트)로 통신을 시도할 것
- 이때 일반적으로 사용되는 80번, 443번 포트를 netcat으로 리스닝하고 있으면 패킷을 확인 가능
### netcat 설치

- 윈도우가 바이러스로 인식할 수도 있으므로 실시간 보호를 끄고 다운로드 후 제외 항목에 추가
- 시스템 환경 변수에 추가해야 cmd에서 바로 사용 가능
### netcat 특징

- 리스닝 모드에서 netcat은 서버로 동작
- 연결 모드에서는 클라이언트로 동작
- 네트워크 상에서 전송된 데이트를 표준 입력으로 수신 가능
- 수신한 모든 데이터는 표준 출력으로 화면에 출력 가능
### netcat을 이용한 포트 리스닝

```PowerShell
C:\> nc -l -p [포트 번호]
```

- `- l` = 리스닝 모드
- `-p [포트 번호]` = 로컬 포트 지정

### netcat을 이용한 악성 코드 분석

1. ApateDNS를 사용해 악성 코드의 DNS request에 대한 DNS reply를 분석가가 설정한 IP로 변경
2. netcat을 사용해 80, 443번 포트를 리스닝
	- 악성 코드는 일반적으로 80번 (HTTP), 443번 (HTTPS) 포트를 사용
	- 일반적으로 차단되어 있지 않고 외부 연결 시 감시하지 않기 때문

```PowerShell
C:\> nc -l -p 80
```

```PowerShell
C:\> nc -l -p 443
```

3. 만약 악성 코드가 해당 포트를 사용하여 통신을 한다면 패킷 정보 확인 가능

## 3. INetSim 설정

### KaliVM 설정

1. cmd 실행 후 자신의 ip 주소 확인 및 

```Bash
# 자신의 ip 주소 확인
ip addr
```

![IMG-네트워킹 분석 가이드 (ApateDNS, netcat, INetSim)-20240818160206417.png](images/네트워킹%20분석%20가이드%20(ApateDNS,%20netcat,%20INetSim)/IMG-네트워킹%20분석%20가이드%20(ApateDNS,%20netcat,%20INetSim)-20240818160206417.png)

2. inetsim.config 수정

```Bash
# INetSim 설정 파일을 백업하고 오픈
cd /etc/inetsim
sudo cp inetsim.config inetsim.config.bak
vim /etc/inetsim/inetsim.config
# vim을 사용하여 service_bind_address, dns_default_ip를 자신의 ip로 수정
# /[찾고자하는 단어]를 사용하여 해당 설정을 찾고 주석을 해제한 후 자신의 ip로 변경
# 설정이 완료되면 :wq를 입력하고 종료
```

![IMG-네트워킹 분석 가이드 (ApateDNS, netcat, INetSim)-20240818160208887.png](images/네트워킹%20분석%20가이드%20(ApateDNS,%20netcat,%20INetSim)/IMG-네트워킹%20분석%20가이드%20(ApateDNS,%20netcat,%20INetSim)-20240818160208887.png)

![IMG-네트워킹 분석 가이드 (ApateDNS, netcat, INetSim)-20240818160212426.png](images/네트워킹%20분석%20가이드%20(ApateDNS,%20netcat,%20INetSim)/IMG-네트워킹%20분석%20가이드%20(ApateDNS,%20netcat,%20INetSim)-20240818160212426.png)

3. inetsim 실행

```Bash
inetsim
```

### 윈도우VM 설정

1. cmd를 실행 후 자신의 ip 주소 확인

```PowerShell
ipconfig
```

![IMG-네트워킹 분석 가이드 (ApateDNS, netcat, INetSim)-20240818160214770.png](images/네트워킹%20분석%20가이드%20(ApateDNS,%20netcat,%20INetSim)/IMG-네트워킹%20분석%20가이드%20(ApateDNS,%20netcat,%20INetSim)-20240818160214770.png)

2. 네트워크 설정
	- 제어판 > 네트워크 및 인터넷 > 네트워크 연결 > 이더넷 속성 > 인터넷 프로토콜 버전 4
	- 다음 IP 주소 사용, 다음 DNS 주소 사용
		- ip 주소 = 자신의 주소
		- 기본 게이트웨이 = KaliVM 주소
		- 기본 설정 DNS 서버 = KaliVM 주소

![IMG-네트워킹 분석 가이드 (ApateDNS, netcat, INetSim)-20240818160214833.png](images/네트워킹%20분석%20가이드%20(ApateDNS,%20netcat,%20INetSim)/IMG-네트워킹%20분석%20가이드%20(ApateDNS,%20netcat,%20INetSim)-20240818160214833.png)

3. 재부팅