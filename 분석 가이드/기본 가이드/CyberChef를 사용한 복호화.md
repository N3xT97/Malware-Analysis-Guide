## CyberChef

> [!info] CyberChef
> https://github.com/gchq/CyberChef

다양한 암호화를 지원하는 분석툴로 온라인, 오프라인 환경에서 모두 이용 가능.

## AES 복호화

### AES 정보 확인

dnspy로 악성 코드를 분석하는 도중 dotnet 내부에 AES를 사용하는 암호화를 발견. KeySize, BlockSize, CipherMode, PaddingMode 정보 확인 가능.

![](images/CyberChef를%20사용한%20복호화/IMG-CyberChef를%20사용한%20복호화-20240919171545973.png)

CyberChef는 PaddingMode가 PKCS7인 AES Decrypt를 지원함.

![](images/CyberChef를%20사용한%20복호화/IMG-CyberChef를%20사용한%20복호화-20240919172040842.png)

### AES Key 구하기

AES Encrypt Key를 확인하기 위해 thIxrsJXpU가 어디서 Assign되는지 확인

![](images/CyberChef를%20사용한%20복호화/IMG-CyberChef를%20사용한%20복호화-20240919172254090.png)

![](images/CyberChef를%20사용한%20복호화/IMG-CyberChef를%20사용한%20복호화-20240919172140728.png)

AES Key는 rLbmKwyrUDcRYd라는 함수 내에서 Rfc2898DeriveBytes 함수에 의해서 생성됨. 

![](images/CyberChef를%20사용한%20복호화/IMG-CyberChef를%20사용한%20복호화-20240919172422588.png)

해당 함수를 찾아보니 암호 기반 키 파생 기능인 PBKDF2를 구현한다고 되어 있음.

```c#
public Rfc2898DeriveBytes (byte[] password, byte[] salt, int iterations);
```

>[!info] Rfc2898DeriveBytes
>https://learn.microsoft.com/ko-kr/dotnet/api/system.security.cryptography.rfc2898derivebytes?view=net-8.0

PBKDF2 또한 CyberChef에서 지원하는 알고리즘임.

![](images/CyberChef를%20사용한%20복호화/IMG-CyberChef를%20사용한%20복호화-20240919172919002.png)

우리가 Decrypt하고자하는 AES의 Key size는 256이고 코드에서 확인한 반복 회수는 50000 임. 또한 함수 내부를 살펴보면 SHA1 알고리즘을 사용한 다는 것도 확인 가능함.

![](images/CyberChef를%20사용한%20복호화/IMG-CyberChef를%20사용한%20복호화-20240919173949065.png)

먼저 Pass 값을 확인하기 위해서 해당 함수에 어떤 값이 전달되는지 확인할 필요가 있음.

![](images/CyberChef를%20사용한%20복호화/IMG-CyberChef를%20사용한%20복호화-20240919174332346.png)

![](images/CyberChef를%20사용한%20복호화/IMG-CyberChef를%20사용한%20복호화-20240919174705507.png)

해당 함수는 TEcGeTTkKXPrijmN 함수에서 호출되며, Base64 디코딩된 XqqDBwjaELqXAZq 값이 전달됨.

![](images/CyberChef를%20사용한%20복호화/IMG-CyberChef를%20사용한%20복호화-20240919174545149.png)

Salt 값으로는 QBmUzntuXqvI라는 바이트 열이 전달됨.

![](images/CyberChef를%20사용한%20복호화/IMG-CyberChef를%20사용한%20복호화-20240919175228379.png)

![](images/CyberChef를%20사용한%20복호화/IMG-CyberChef를%20사용한%20복호화-20240919175253783.png)

![](images/CyberChef를%20사용한%20복호화/IMG-CyberChef를%20사용한%20복호화-20240919175422668.png)

해당 정보를 토대로 CyberChef에서 PBKDF2 알고리즘을 실행하면 256bit(= 32byte) 키를 획들할 수 있음.

![](images/CyberChef를%20사용한%20복호화/IMG-CyberChef를%20사용한%20복호화-20240919175505140.png)

### IV 구하기

AES Key를 구한 이후에는 IV를 구해야 함. 코드를 확인해보면 qRHqCFYVDfrq 함수에 전달된 값의 첫 16 bytes를 사용하는 것을 알 수 있음.

![](images/CyberChef를%20사용한%20복호화/IMG-CyberChef를%20사용한%20복호화-20240919180210079.png)

qRHqCFYVDfrq 함수에 전달되는 인수를 역추적 해보면 base64로 인코딩된 문자열들을 확인할 수 있음. 결과적으로 qRHqCFYVDfrq 함수에 전달되는 문자열은 base64 디코딩된 문자열임. 

![](images/CyberChef를%20사용한%20복호화/IMG-CyberChef를%20사용한%20복호화-20240919180711065.png)

![](images/CyberChef를%20사용한%20복호화/IMG-CyberChef를%20사용한%20복호화-20240919185612732.png)

![](images/CyberChef를%20사용한%20복호화/IMG-CyberChef를%20사용한%20복호화-20240919180742547.png)

![](images/CyberChef를%20사용한%20복호화/IMG-CyberChef를%20사용한%20복호화-20240919180802653.png)

dnspy에서 확인한 base64 문자열을 CyberChef 디코딩하여 첫 16 bytes를 IV로 사용.

![](images/CyberChef를%20사용한%20복호화/IMG-CyberChef를%20사용한%20복호화-20240919200851981.png)

### AES 복호화

구한 IV를 사용하여, IV로 사용된 16 bytes를 제외한 이후 데이터를 AES Decrypt. 쓰레기 값 뒤에 악성 도메인을 확인 가능.

![](images/CyberChef를%20사용한%20복호화/IMG-CyberChef를%20사용한%20복호화-20240919201046899.png)

