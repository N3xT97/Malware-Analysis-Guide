## docx

### docx

- Microsoft Word에서 만든 문서를 만들고 저장하는 데 사용되는 파일 형식
- Microsoft Word 버전 2007 이상의 기본 파일 형식이며 이전 DOC 파일 형식을 대체
- ML과 ZIP 압축이 결합된 Open XML 파일 형식을 기반
- 압축 해제를 통해 내부 내용을 확인할 수 있음.

![](images/docx%20분석%20(template%20injection,%20vba%20macros)/IMG-docx%20분석%20(template%20injection,%20vba%20macros)-20240910114712389.png)


### \\word\\media\\

악성 코드에서는 정상적인 파일로 보이게 하기 위해 이미지를 활용하는 경우가 존재

![399](images/docx%20분석%20(template%20injection,%20vba%20macros)/IMG-docx%20분석%20(template%20injection,%20vba%20macros)-20240910114712501.png)

해당 폴더에서는 docx 파일에 사용된 image를 확인 가능

![439](images/docx%20분석%20(template%20injection,%20vba%20macros)/IMG-docx%20분석%20(template%20injection,%20vba%20macros)-20240910114712601.png)


### \\word\\\_rels\\settings.xml.rels

공격자는 settings.xml.rels 내의 Target 중 하나를 Injection 하고자하는 파일의 위치로 변경.

![556](images/docx%20분석%20(template%20injection,%20vba%20macros)/IMG-docx%20분석%20(template%20injection,%20vba%20macros)-20240910114712722.png)

## Analysis

### Template Injection

1. oleid를 사용하여 .docx 파일을 분석
	- External Relations의 Risk가 HIGH이면 Tamplate Injection을 의심해봐야 함.

```POWERSHELL
oleid <filename>
```

![531](images/docx%20분석%20(template%20injection,%20vba%20macros)/IMG-docx%20분석%20(template%20injection,%20vba%20macros)-20240910114712861.png)


2. oleobj를 사용하여 External Relationships 확인

```
oleobj <filename>
```

![584](images/docx%20분석%20(template%20injection,%20vba%20macros)/IMG-docx%20분석%20(template%20injection,%20vba%20macros)-20240910114712960.png)


3. 공격자가 Injection 하고자하는 .dotm 파일 다운로드

```POWERSHELL
Invoke-WebRequest -Uri <src> -OutFile <dst>
```


4. oleid를 사용하여 .dotm 파일을 분석
	- VBA Macros의 Risk가 HIGH면, 악성 코드임을 의심해 봐야함.

![531](images/docx%20분석%20(template%20injection,%20vba%20macros)/IMG-docx%20분석%20(template%20injection,%20vba%20macros)-20240910114713057.png)

5. olevba를 사용하여 vba 매크로 확인

![531](images/docx%20분석%20(template%20injection,%20vba%20macros)/IMG-docx%20분석%20(template%20injection,%20vba%20macros)-20240910114713149.png)

### VBA Macros

위의 4번, 5번을 진행하면 됨.