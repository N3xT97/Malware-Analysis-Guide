```python
def SetKey(key):
    key = (((key * 0x343fd) & 0xffffffff) + 0x269ec3) & 0xffffffff
    return key

def Decrypt(enc, key):
    dec = b''
    for b in enc:
        key = SetKey(key)
        dec += chr((b & 0xff) ^ (((key >> 0x10) & 0x7fff) & 0xff))
    return dec


if __name__ == "__main__":
    initial_key = 0xEDB88FC6
    
    enc_ptr = toAddr(0x41BBC0)
    enc_size = 0x0001BCD7
    enc = getBytes(enc_ptr, enc_size)
    
    dec = Decrypt(enc, initial_key)
    
    fpath = 'C:\\Users\\user\\Desktop\\Lockbit\\ghidra_pj\\stage1.bin'
    with open(fpath, 'wb') as f:
        f.write(dec)
```

```python
import struct
from ghidra.app.emulator import EmulatorHelper

def KeyOperation(key):
    key_out = (((key * 0x343fd) & 0xffffffff) + 0x269ec3) & 0xffffffff
    return key_out

def Decrypt(enc, key):
    dec = b''
    for b in enc:
        key = KeyOperation(key)
        dec += chr((b & 0xff) ^ (((key >> 0x10) & 0x7fff) & 0xff))
    return dec

def Decode(decode_function_ptr, encode):
    emu = EmulatorHelper(currentProgram)
    
    end_ptr = toAddr(0xffffffff)
    stack_ptr = toAddr(0xa00000)
    encode_ptr = toAddr(0xe00000)
    encode_size = len(encode)
    decode_ptr = toAddr(0xf00000)
    decode_size_ptr = toAddr(0xb0000)
    
    emu.writeRegister(emu.getStackPointerRegister(), stack_ptr.getOffset())
    emu.writeMemory(encode_ptr, encode)
    emu.writeMemoryValue(stack_ptr, 4, end_ptr.getOffset())
    emu.writeMemoryValue(stack_ptr.add(4), 4, encode_ptr.getOffset())
    emu.writeMemoryValue(stack_ptr.add(8), 4, encode_size)
    emu.writeMemoryValue(stack_ptr.add(0xc), 4, decode_ptr.getOffset())
    emu.writeMemoryValue(stack_ptr.add(0x10), 4, decode_size_ptr.getOffset())
    emu.writeRegister(emu.getPCRegister(), decode_function_ptr.getOffset())
    
    while monitor.isCancelled() is False:
        current_ptr = emu.getExecutionAddress()
        if (current_ptr == end_ptr):
            decode_size = struct.unpack('<I', emu.readMemory(decode_size_ptr, 4).tostring())[0]
            decode = emu.readMemory(decode_ptr, decode_size)
            return (decode.tostring(), decode_size)
        res = emu.step(monitor)
    emu.dispose()
	
if __name__ == '__main__':
    enc_ptr = toAddr(0x01000842)
    enc_size = 0x1B268
    enc = getBytes(enc_ptr, enc_size)
    
    initial_key = 0x80000001
    
    decrypt = Decrypt(enc, initial_key)
    (decode, decode_size) = Decode(toAddr(0x010004f2), decrypt)
    
    print('[*] Stage2 Size = {0:010X}'.format(decode_size))
    
    fpath = 'C:\\Users\\user\\Desktop\\malware\\Lockbit\\ghidra_pj\\stage2.bin'
    with open(fpath, 'wb') as f:
        f.write(decode)
```